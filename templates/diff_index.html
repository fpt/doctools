<!DOCTYPE html>
<html>
<head>
  {% include 'hheader.html' %}
  <title>{{ s.gettext('sh_diff') }}</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" media="screen">
  <link href="{{ url_for('static', filename='css/bootstrap-theme.min.css') }}" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dropzone.css') }}">
<style>
.diff-pane {
  background-color: #fff;
  box-shadow: .1em .1em .5em rgba(0,0,0,.45);
}

em.str-diff {
  font-weight: normal;
  font-style: normal;
  background-color:#E99;
}

pre {
  font-family: monospace;
  line-height: 0;
  counter-reset: line;
  overflow-x: auto;
  white-space: nowrap;
}

pre.multi-line {
  font-family: monospace;
  line-height: 0;
  counter-reset: line;
  white-space: pre-wrap;       /* Since CSS 2.1 */
  white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
  white-space: -pre-wrap;      /* Opera 4-6 */
  white-space: -o-pre-wrap;    /* Opera 7 */
  word-wrap: break-word;       /* Internet Explorer 5.5+ */
}

span.line-num {
  display: block;
  line-height: 1.5rem;
}

span.line-num:before {
  counter-increment: line;
  content: counter(line);
  display: inline-block;
  border-right: 1px solid #ddd;
  padding: 0 .5em;
  margin-right: .5em;
  color: #888
}

.rel-line {
  position:absolute;
  width:2px;
  background-color:#F88;
} 

.diff-block {
  display: block;
  background-color:#FCC;
}

.compare-filename {
  width: 100%;
}

</style>
</head>

<body>

<ol class="breadcrumb">
  <li><a href="{{ url_for('top.index') }}">{{ s.gettext('site_title') }} {{ s.gettext('nav_top') }}</a></li>
  <li class="active">{{ s.gettext('sh_diff') }}</li>
</ol>

<div class="container">
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dropzone.js') }}"></script>

  <h1>{{ s.gettext('sh_diff') }}</h1>

  <div class="panel panel-default">
    <div class="panel-heading">{{ s.gettext('dh_diff') }}</div>
    <div class="panel-body">
      {{ s.gettext('dd_diff') }}
    </div>
  </div>

  <div class="panel panel-default">
    <div class="row">
      <div class="col-sm-12">
        <form action="/diff/compare" class="dropzone" id="diff-dropzone"></form>
      </div>
      <div class="col-sm-12">
        <button id="btn-compare" class="btn btn-primary">Compare</button>
        <input id="chk-line-toggle" class="btn" type="checkbox">Toggle multiline</button>
      </div>
      <div class="col-sm-6 diff-pane">
        <input id="left-filename" class="compare-filename" type="text" readonly="readonly" />
        <pre id="left-pane"></pre>
      </div>
      <div class="col-sm-6 diff-pane">
        <input id="right-filename" class="compare-filename" type="text" readonly="readonly" />
        <pre id="right-pane"></pre>
      </div>
    </div>
  </div>

<script>
// workaround for
// https://gitlab.com/meno/dropzone/issues/43
if (!FileList.prototype.map) {
  FileList.prototype.map = Array.prototype.map
}


// maybe useful
// https://css-tricks.com/examples/ShapesOfCSS/
function adjustLine(from, to, line){

  var fT = from.top;
  var tT = to.top;
  var fL = from.left;
  var tL = to.left;
  
  var CA   = Math.abs(tT - fT);
  var CO   = Math.abs(tL - fL);
  var H    = Math.sqrt(CA*CA + CO*CO);
  var ANG  = 180 / Math.PI * Math.acos( CA/H );

  if(tT > fT){
      var top  = (tT-fT)/2 + fT;
  }else{
      var top  = (fT-tT)/2 + tT;
  }
  if(tL > fL){
      var left = (tL-fL)/2 + fL;
  }else{
      var left = (fL-tL)/2 + tL;
  }

  if(( fT < tT && fL < tL) || ( tT < fT && tL < fL) || (fT > tT && fL > tL) || (tT > fT && tL > fL)){
    ANG *= -1;
  }
  top-= H/2;

  line.style["-webkit-transform"] = 'rotate('+ ANG +'deg)';
  line.style["-moz-transform"] = 'rotate('+ ANG +'deg)';
  line.style["-ms-transform"] = 'rotate('+ ANG +'deg)';
  line.style["-o-transform"] = 'rotate('+ ANG +'deg)';
  line.style["-transform"] = 'rotate('+ ANG +'deg)';
  line.style.top    = top+'px';
  line.style.left   = left+'px';
  line.style.height = H + 'px';
}


function connectDiffBlocks(diff_lines) {
  $(".rel-line").remove();

  diff_lines.forEach(function(i) {
    var d1 = $("." + i[0]);
    var d2 = $("." + i[1]);
    if (!d1.get(0) || !d2.get(0))
      return;

    var l = $('<div class="rel-line"/>');

    adjustLine(
      {top: d1.offset().top, left:d1.offset().left + d1.parent().width()}, 
      d2.offset(),
      l.get(0)
    );      

    $('body').append(l);
  })
}

var diff_lines;

Dropzone.options.diffDropzone = {

  // Prevents Dropzone from uploading dropped files immediately
  autoProcessQueue: false,
  uploadMultiple: true,
  parallelUploads: 100,
  maxFiles: 100,

  init: function() {
    var submitButton = document.querySelector("#btn-compare")
        myDropzone = this; // closure

    submitButton.addEventListener("click", function(e) {
      e.preventDefault();
      e.stopPropagation();
      myDropzone.processQueue(); // Tell Dropzone to process all queued files.
    });

    // You might want to show the submit button only when 
    // files are dropped here:
    this.on("addedfile", function() {
      // Show submit button here and/or inform user to click it.
    });
  },
  success: function(e, result) {
    console.log('hoge')
    console.log(result)

    $('#left-pane').html(result.left_result)
    $('#right-pane').html(result.right_result)
    $('#left-filename').val(result.left_filename)
    $('#right-filename').val(result.right_filename)
    connectDiffBlocks(result.diff_lines);
    diff_lines = result.diff_lines;
  }
};

$('#chk-line-toggle').bind('click', function(){
  $('pre').toggleClass('multi-line');
  if (diff_lines)
    connectDiffBlocks(diff_lines);
})

$(window).resize(function() {
  if (diff_lines)
    connectDiffBlocks(diff_lines);
});

</script>

</div>

</body>
</html>
